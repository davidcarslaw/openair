<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Conditional quantile estimates for model evaluation — conditionalQuantile • openair</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Conditional quantile estimates for model evaluation — conditionalQuantile"><meta name="description" content="Function to calculate conditional quantiles with flexible conditioning. The
function is for use in model evaluation and more generally to help better
understand forecast predictions and how well they agree with observations."><meta property="og:description" content="Function to calculate conditional quantiles with flexible conditioning. The
function is for use in model evaluation and more generally to help better
understand forecast predictions and how well they agree with observations."><meta property="og:image" content="https://davidcarslaw.github.io/openair/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">openair</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.18.2.9004</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/openair.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bookdown.org/david_carslaw/openair/">Book (external)</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/davidcarslaw/openair/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Conditional quantile estimates for model evaluation</h1>
      <small class="dont-index">Source: <a href="https://github.com/davidcarslaw/openair/blob/master/R/conditionalQuantile.R" class="external-link"><code>R/conditionalQuantile.R</code></a></small>
      <div class="d-none name"><code>conditionalQuantile.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Function to calculate conditional quantiles with flexible conditioning. The
function is for use in model evaluation and more generally to help better
understand forecast predictions and how well they agree with observations.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">conditionalQuantile</span><span class="op">(</span></span>
<span>  <span class="va">mydata</span>,</span>
<span>  obs <span class="op">=</span> <span class="st">"obs"</span>,</span>
<span>  mod <span class="op">=</span> <span class="st">"mod"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>  bins <span class="op">=</span> <span class="fl">31</span>,</span>
<span>  min.bin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"predicted value"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"observed value"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"YlOrRd"</span><span class="op">)</span>,</span>
<span>  key.columns <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  key.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>  auto.text <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-mydata">mydata<a class="anchor" aria-label="anchor" href="#arg-mydata"></a></dt>
<dd><p>A data frame containing the field <code>obs</code> and <code>mod</code>
representing observed and modelled values.</p></dd>


<dt id="arg-obs">obs<a class="anchor" aria-label="anchor" href="#arg-obs"></a></dt>
<dd><p>The name of the observations in <code>mydata</code>.</p></dd>


<dt id="arg-mod">mod<a class="anchor" aria-label="anchor" href="#arg-mod"></a></dt>
<dd><p>The name of the predictions (modelled values) in <code>mydata</code>.</p></dd>


<dt id="arg-type">type<a class="anchor" aria-label="anchor" href="#arg-type"></a></dt>
<dd><p><code>type</code> determines how the data are split i.e. conditioned,
and then plotted. The default is will produce a single plot using the
entire data. Type can be one of the built-in types as detailed in
<code>cutData</code> e.g. “season”, “year”, “weekday” and so
on. For example, <code>type = "season"</code> will produce four plots — one for
each season.</p>
<p>It is also possible to choose <code>type</code> as another variable in the data
frame. If that variable is numeric, then the data will be split into four
quantiles (if possible) and labelled accordingly. If type is an existing
character or factor variable, then those categories/levels will be used
directly. This offers great flexibility for understanding the variation of
different variables and how they depend on one another.</p>
<p>Type can be up length two e.g. <code>type = c("season", "weekday")</code> will
produce a 2x2 plot split by season and day of the week. Note, when two
types are provided the first forms the columns and the second the rows.</p></dd>


<dt id="arg-bins">bins<a class="anchor" aria-label="anchor" href="#arg-bins"></a></dt>
<dd><p>Number of bins to be used in calculating the different quantile
levels.</p></dd>


<dt id="arg-min-bin">min.bin<a class="anchor" aria-label="anchor" href="#arg-min-bin"></a></dt>
<dd><p>The minimum number of points required for the estimates of the
25/75th and 10/90th percentiles.</p></dd>


<dt id="arg-xlab">xlab<a class="anchor" aria-label="anchor" href="#arg-xlab"></a></dt>
<dd><p>label for the x-axis, by default “predicted value”.</p></dd>


<dt id="arg-ylab">ylab<a class="anchor" aria-label="anchor" href="#arg-ylab"></a></dt>
<dd><p>label for the y-axis, by default “observed value”.</p></dd>


<dt id="arg-col">col<a class="anchor" aria-label="anchor" href="#arg-col"></a></dt>
<dd><p>Colours to be used for plotting the uncertainty bands and median
line. Must be of length 5 or more.</p></dd>


<dt id="arg-key-columns">key.columns<a class="anchor" aria-label="anchor" href="#arg-key-columns"></a></dt>
<dd><p>Number of columns to be used in the key.</p></dd>


<dt id="arg-key-position">key.position<a class="anchor" aria-label="anchor" href="#arg-key-position"></a></dt>
<dd><p>Location of the key e.g. “top”, “bottom”,
“right”, “left”. See <code>lattice</code> <code>xyplot</code> for more
details.</p></dd>


<dt id="arg-auto-text">auto.text<a class="anchor" aria-label="anchor" href="#arg-auto-text"></a></dt>
<dd><p>Either <code>TRUE</code> (default) or <code>FALSE</code>. If <code>TRUE</code>
titles and axis labels etc. will automatically try and format pollutant
names and units properly e.g.  by subscripting the `2' in NO2.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Other graphical parameters passed onto <code>cutData</code> and
<code>lattice:xyplot</code>. For example, <code>conditionalQuantile</code> passes the
option <code>hemisphere = "southern"</code> on to <code>cutData</code> to provide
southern (rather than default northern) hemisphere handling of <code>type = "season"</code>. Similarly, common axis and title labelling options (such as
<code>xlab</code>, <code>ylab</code>, <code>main</code>) are passed to <code>xyplot</code> via
<code>quickText</code> to handle routine formatting.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Conditional quantiles are a very useful way of considering model performance
against observations for continuous measurements (Wilks, 2005). The
conditional quantile plot splits the data into evenly spaced bins. For each
predicted value bin e.g. from 0 to 10~ppb the <em>corresponding</em> values of
the observations are identified and the median, 25/75th and 10/90 percentile
(quantile) calculated for that bin. The data are plotted to show how these
values vary across all bins. For a time series of observations and
predictions that agree precisely the median value of the predictions will
equal that for the observations for each bin.</p>
<p>The conditional quantile plot differs from the quantile-quantile plot (Q-Q
plot) that is often used to compare observations and predictions. A Q-Q~plot
separately considers the distributions of observations and predictions,
whereas the conditional quantile uses the corresponding observations for a
particular interval in the predictions. Take as an example two time series,
the first a series of real observations and the second a lagged time series
of the same observations representing the predictions. These two time series
will have identical (or very nearly identical) distributions (e.g. same
median, minimum and maximum). A Q-Q plot would show a straight line showing
perfect agreement, whereas the conditional quantile will not. This is because
in any interval of the predictions the corresponding observations now have
different values.</p>
<p>Plotting the data in this way shows how well predictions agree with
observations and can help reveal many useful characteristics of how well
model predictions agree with observations — across the full distribution of
values. A single plot can therefore convey a considerable amount of
information concerning model performance. The <code>conditionalQuantile</code>
function in openair allows conditional quantiles to be considered in a
flexible way e.g. by considering how they vary by season.</p>
<p>The function requires a data frame consisting of a column of observations and
a column of predictions. The observations are split up into <code>bins</code>
according to values of the predictions. The median prediction line together
with the 25/75th and 10/90th quantile values are plotted together with a line
showing a “perfect” model. Also shown is a histogram of predicted
values (shaded grey) and a histogram of observed values (shown as a blue
line).</p>
<p>Far more insight can be gained into model performance through conditioning
using <code>type</code>. For example, <code>type = "season"</code> will plot conditional
quantiles by each season. <code>type</code> can also be a factor or character field
e.g. representing different models used.</p>
<p>See Wilks (2005) for more details and the examples below.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Murphy, A. H., B.G. Brown and Y. Chen. (1989) Diagnostic Verification of
Temperature Forecasts, Weather and Forecasting, Volume: 4, Issue: 4, Pages:
485-501.</p>
<p>Wilks, D. S., 2005. Statistical Methods in the Atmospheric Sciences, Volume
91, Second Edition (International Geophysics), 2nd Edition. Academic Press.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>The <code>verification</code> package for comprehensive functions for
forecast verification.</p>
<p>Other model evaluation functions:
<code><a href="TaylorDiagram.html">TaylorDiagram</a>()</code>,
<code><a href="conditionalEval.html">conditionalEval</a>()</code>,
<code><a href="modStats.html">modStats</a>()</code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>David Carslaw</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## make some dummy prediction data based on 'nox'</span></span></span>
<span class="r-in"><span><span class="va">mydata</span><span class="op">$</span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mydata</span><span class="op">$</span><span class="va">nox</span> <span class="op">*</span> <span class="fl">1.1</span> <span class="op">+</span> <span class="va">mydata</span><span class="op">$</span><span class="va">nox</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># basic conditional quantile plot</span></span></span>
<span class="r-in"><span><span class="co">## A "perfect" model is shown by the blue line</span></span></span>
<span class="r-in"><span><span class="co">## predictions tend to be increasingly positively biased at high nox,</span></span></span>
<span class="r-in"><span><span class="co">## shown by departure of median line from the blue one.</span></span></span>
<span class="r-in"><span><span class="co">## The widening uncertainty bands with increasing NOx shows that</span></span></span>
<span class="r-in"><span><span class="co">## hourly predictions are worse for higher NOx concentrations.</span></span></span>
<span class="r-in"><span><span class="co">## Also, the red (median) line extends beyond the data (blue line),</span></span></span>
<span class="r-in"><span><span class="co">## which shows in this case some predictions are much higher than</span></span></span>
<span class="r-in"><span><span class="co">## the corresponding measurements. Note that the uncertainty bands</span></span></span>
<span class="r-in"><span><span class="co">## do not extend as far as the median line because there is insufficient</span></span></span>
<span class="r-in"><span><span class="co"># to calculate them</span></span></span>
<span class="r-in"><span><span class="fu">conditionalQuantile</span><span class="op">(</span><span class="va">mydata</span>, obs <span class="op">=</span> <span class="st">"nox"</span>, mod <span class="op">=</span> <span class="st">"mod"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="conditionalQuantile-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## can split by season to show seasonal performance (not very</span></span></span>
<span class="r-in"><span><span class="co">## enlightening in this case - try some real data and it will be!)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">conditionalQuantile</span><span class="op">(</span><span class="va">mydata</span>, obs <span class="op">=</span> <span class="st">"nox"</span>, mod <span class="op">=</span> <span class="st">"mod"</span>, type <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Carslaw, Jack Davison, Karl Ropkins.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

