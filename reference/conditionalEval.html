<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Conditional quantile estimates with additional variables for model evaluation — conditionalEval • openair</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Conditional quantile estimates with additional variables for model evaluation — conditionalEval"><meta name="description" content="This function enhances conditionalQuantile() by also considering how other
variables vary over the same intervals. Conditional quantiles are very useful
on their own for model evaluation, but provide no direct information on how
other variables change at the same time. For example, a conditional quantile
plot of ozone concentrations may show that low concentrations of ozone tend
to be under-predicted. However, the cause of the under-prediction can be
difficult to determine. However, by considering how well the model predicts
other variables over the same intervals, more insight can be gained into the
underlying reasons why model performance is poor."><meta property="og:description" content="This function enhances conditionalQuantile() by also considering how other
variables vary over the same intervals. Conditional quantiles are very useful
on their own for model evaluation, but provide no direct information on how
other variables change at the same time. For example, a conditional quantile
plot of ozone concentrations may show that low concentrations of ozone tend
to be under-predicted. However, the cause of the under-prediction can be
difficult to determine. However, by considering how well the model predicts
other variables over the same intervals, more insight can be gained into the
underlying reasons why model performance is poor."><meta property="og:image" content="https://davidcarslaw.github.io/openair/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">openair</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.18.2.9004</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/openair.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bookdown.org/david_carslaw/openair/">Book (external)</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/davidcarslaw/openair/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Conditional quantile estimates with additional variables for model evaluation</h1>
      <small class="dont-index">Source: <a href="https://github.com/davidcarslaw/openair/blob/master/R/conditionalEval.R" class="external-link"><code>R/conditionalEval.R</code></a></small>
      <div class="d-none name"><code>conditionalEval.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function enhances <code><a href="conditionalQuantile.html">conditionalQuantile()</a></code> by also considering how other
variables vary over the same intervals. Conditional quantiles are very useful
on their own for model evaluation, but provide no direct information on how
other variables change at the same time. For example, a conditional quantile
plot of ozone concentrations may show that low concentrations of ozone tend
to be under-predicted. However, the cause of the under-prediction can be
difficult to determine. However, by considering how well the model predicts
other variables over the same intervals, more insight can be gained into the
underlying reasons why model performance is poor.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">conditionalEval</span><span class="op">(</span></span>
<span>  <span class="va">mydata</span>,</span>
<span>  obs <span class="op">=</span> <span class="st">"obs"</span>,</span>
<span>  mod <span class="op">=</span> <span class="st">"mod"</span>,</span>
<span>  var.obs <span class="op">=</span> <span class="st">"var.obs"</span>,</span>
<span>  var.mod <span class="op">=</span> <span class="st">"var.mod"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>  bins <span class="op">=</span> <span class="fl">31</span>,</span>
<span>  statistic <span class="op">=</span> <span class="st">"MB"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"predicted value"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"statistic"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"YlOrRd"</span><span class="op">)</span>,</span>
<span>  col.var <span class="op">=</span> <span class="st">"Set1"</span>,</span>
<span>  var.names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  auto.text <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-mydata">mydata<a class="anchor" aria-label="anchor" href="#arg-mydata"></a></dt>
<dd><p>A data frame containing the field <code>obs</code> and <code>mod</code>
representing observed and modelled values.</p></dd>


<dt id="arg-obs">obs<a class="anchor" aria-label="anchor" href="#arg-obs"></a></dt>
<dd><p>The name of the observations in <code>mydata</code>.</p></dd>


<dt id="arg-mod">mod<a class="anchor" aria-label="anchor" href="#arg-mod"></a></dt>
<dd><p>The name of the predictions (modelled values) in <code>mydata</code>.</p></dd>


<dt id="arg-var-obs">var.obs<a class="anchor" aria-label="anchor" href="#arg-var-obs"></a></dt>
<dd><p>Other variable observations for which statistics should be
calculated. Can be more than length one e.g. <code>var.obs = c("nox.obs", "ws.obs")</code>. Note that including other variables could reduce the number of
data available to plot due to the need of having non-missing data for all
variables.</p></dd>


<dt id="arg-var-mod">var.mod<a class="anchor" aria-label="anchor" href="#arg-var-mod"></a></dt>
<dd><p>Other variable predictions for which statistics should be
calculated. Can be more than length one e.g. <code>var.obs = c("nox.obs", "ws.obs")</code>.</p></dd>


<dt id="arg-type">type<a class="anchor" aria-label="anchor" href="#arg-type"></a></dt>
<dd><p><code>type</code> determines how the data are split i.e. conditioned,
and then plotted. The default is will produce a single plot using the
entire data. Type can be one of the built-in types as detailed in
<code>cutData</code> e.g. "season", "year", "weekday" and so on. For example,
<code>type = "season"</code> will produce four plots — one for each season.</p>
<p>It is also possible to choose <code>type</code> as another variable in the data
frame. If that variable is numeric, then the data will be split into four
quantiles (if possible) and labelled accordingly. If type is an existing
character or factor variable, then those categories/levels will be used
directly. This offers great flexibility for understanding the variation of
different variables and how they depend on one another.</p></dd>


<dt id="arg-bins">bins<a class="anchor" aria-label="anchor" href="#arg-bins"></a></dt>
<dd><p>Number of bins to be used in calculating the different quantile
levels.</p></dd>


<dt id="arg-statistic">statistic<a class="anchor" aria-label="anchor" href="#arg-statistic"></a></dt>
<dd><p>Statistic(s) to be plotted. Can be “MB”,
“NMB”, “r”, “COE”, “MGE”, “NMGE”,
“RMSE” and “FAC2”, as described in <code>modStats</code>. When
these statistics are chosen, they are calculated from <code>var.mod</code> and
<code>var.mod</code>.</p>
<p><code>statistic</code> can also be a value that can be supplied to
<code>cutData</code>. For example, <code>statistic = "season"</code> will show how
model performance varies by season across the distribution of predictions
which might highlight that at high concentrations of NOx the model tends to
underestimate concentrations and that these periods mostly occur in winter.
<code>statistic</code> can also be another variable in the data frame — see
<code>cutData</code> for more information. A special case is <code>statistic = "cluster"</code> if clusters have been calculated using <code>trajCluster</code>.</p></dd>


<dt id="arg-xlab">xlab<a class="anchor" aria-label="anchor" href="#arg-xlab"></a></dt>
<dd><p>label for the x-axis, by default “predicted value”.</p></dd>


<dt id="arg-ylab">ylab<a class="anchor" aria-label="anchor" href="#arg-ylab"></a></dt>
<dd><p>label for the y-axis, by default “observed value”.</p></dd>


<dt id="arg-col">col<a class="anchor" aria-label="anchor" href="#arg-col"></a></dt>
<dd><p>Colours to be used for plotting the uncertainty bands and median
line. Must be of length 5 or more.</p></dd>


<dt id="arg-col-var">col.var<a class="anchor" aria-label="anchor" href="#arg-col-var"></a></dt>
<dd><p>Colours for the additional variables to be compared. See
<code>openColours</code> for more details.</p></dd>


<dt id="arg-var-names">var.names<a class="anchor" aria-label="anchor" href="#arg-var-names"></a></dt>
<dd><p>Variable names to be shown on plot for plotting
<code>var.obs</code> and <code>var.mod</code>.</p></dd>


<dt id="arg-auto-text">auto.text<a class="anchor" aria-label="anchor" href="#arg-auto-text"></a></dt>
<dd><p>Either <code>TRUE</code> (default) or <code>FALSE</code>. If <code>TRUE</code>
titles and axis labels etc. will automatically try and format pollutant
names and units properly e.g.  by subscripting the `2' in NO2.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Other graphical parameters passed onto <code>conditionalQuantile</code>
and <code>cutData</code>. For example, <code>conditionalQuantile</code> passes the
option <code>hemisphere = "southern"</code> on to <code>cutData</code> to provide
southern (rather than default northern) hemisphere handling of <code>type = "season"</code>. Similarly, common axis and title labelling options (such as
<code>xlab</code>, <code>ylab</code>, <code>main</code>) are passed to <code>xyplot</code> via
<code>quickText</code> to handle routine formatting.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code>conditionalEval</code> function provides information on how other
variables vary across the same intervals as shown on the conditional quantile
plot. There are two types of variable that can be considered by setting the
value of <code>statistic</code>. First, <code>statistic</code> can be another variable in
the data frame. In this case the plot will show the different proportions of
<code>statistic</code> across the range of predictions. For example <code>statistic = "season"</code> will show for each interval of <code>mod</code> the proportion of
predictions that were spring, summer, autumn or winter. This is useful
because if model performance is worse for example at high concentrations of
<code>mod</code> then knowing that these tend to occur during a particular season
etc. can be very helpful when trying to understand <em>why</em> a model fails.
See <code><a href="cutData.html">cutData()</a></code> for more details on the types of variable that can
be <code>statistic</code>. Another example would be <code>statistic = "ws"</code> (if
wind speed were available in the data frame), which would then split wind
speed into four quantiles and plot the proportions of each.</p>
<p>Second, <code>conditionalEval</code> can simultaneously plot the model performance
of other observed/predicted variable <strong>pairs</strong> according to different
model evaluation statistics. These statistics derive from the
<code><a href="modStats.html">modStats()</a></code> function and include “MB”, “NMB”,
“r”, “COE”, “MGE”, “NMGE”, “RMSE” and
“FAC2”. More than one statistic can be supplied e.g. <code>statistic = c("NMB", "COE")</code>. Bootstrap samples are taken from the corresponding values
of other variables to be plotted and their statistics with 95\<!-- % confidence -->
intervals calculated. In this case, the model <em>performance</em> of other
variables is shown across the same intervals of <code>mod</code>, rather than just
the values of single variables. In this second case the model would need to
provide observed/predicted pairs of other variables.</p>
<p>For example, a model may provide predictions of NOx and wind speed (for which
there are also observations available). The <code>conditionalEval</code> function
will show how well these other variables are predicted for the same intervals
of the main variables assessed in the conditional quantile e.g. ozone. In
this case, values are supplied to <code>var.obs</code> (observed values for other
variables) and <code>var.mod</code> (modelled values for other variables). For
example, to consider how well the model predicts NOx and wind speed
<code>var.obs = c("nox.obs", "ws.obs")</code> and <code>var.mod = c("nox.mod", "ws.mod")</code> would be supplied (assuming <code>nox.obs, nox.mod, ws.obs, ws.mod</code> are present in the data frame). The analysis could show for example,
when ozone concentrations are under-predicted, the model may also be shown to
over-predict concentrations of NOx at the same time, or under-predict wind
speeds. Such information can thus help identify the underlying causes of poor
model performance. For example, an under-prediction in wind speed could
result in higher surface NOx concentrations and lower ozone concentrations.
Similarly if wind speed predictions were good and NOx was over predicted it
might suggest an over-estimate of NOx emissions. One or more additional
variables can be plotted.</p>
<p>A special case is <code>statistic = "cluster"</code>. In this case a data frame is
provided that contains the cluster calculated by <code><a href="trajCluster.html">trajCluster()</a></code>
and <code><a href="importTraj.html">importTraj()</a></code>. Alternatively users could supply their own
pre-calculated clusters. These calculations can be very useful in showing
whether certain back trajectory clusters are associated with poor (or good)
model performance. Note that in the case of <code>statistic = "cluster"</code>
there will be fewer data points used in the analysis compared with the
ordinary statistics above because the trajectories are available for every
three hours. Also note that <code>statistic = "cluster"</code> cannot be used
together with the ordinary model evaluation statistics such as MB. The output
will be a bar chart showing the proportion of each interval of <code>mod</code> by
cluster number.</p>
<p>Far more insight can be gained into model performance through conditioning
using <code>type</code>. For example, <code>type = "season"</code> will plot conditional
quantiles and the associated model performance statistics of other variables
by each season. <code>type</code> can also be a factor or character field e.g.
representing different models used.</p>
<p>See Wilks (2005) for more details of conditional quantile plots.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Wilks, D. S., 2005. Statistical Methods in the Atmospheric
Sciences, Volume 91, Second Edition (International Geophysics), 2nd
Edition. Academic Press.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>The <code>verification</code> package for comprehensive functions for
forecast verification.</p>
<p>Other model evaluation functions:
<code><a href="TaylorDiagram.html">TaylorDiagram</a>()</code>,
<code><a href="conditionalQuantile.html">conditionalQuantile</a>()</code>,
<code><a href="modStats.html">modStats</a>()</code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>David Carslaw</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Carslaw, Jack Davison, Karl Ropkins.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

