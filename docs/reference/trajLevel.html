<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Trajectory level plots with conditioning — trajLevel â€¢ openair</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">openair</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/davidcarslaw/openair">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Trajectory level plots with conditioning</h1>
    </div>

    
    <p>This function plots gridded back trajectories. This function
requires that data are imported using the <code>importTraj</code>
function.</p>
    

    <pre><span class='fu'>trajLevel</span>(<span class='no'>mydata</span>, <span class='kw'>lon</span> <span class='kw'>=</span> <span class='st'>"lon"</span>, <span class='kw'>lat</span> <span class='kw'>=</span> <span class='st'>"lat"</span>, <span class='kw'>pollutant</span> <span class='kw'>=</span> <span class='st'>"height"</span>,
  <span class='kw'>type</span> <span class='kw'>=</span> <span class='st'>"default"</span>, <span class='kw'>smooth</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>statistic</span> <span class='kw'>=</span> <span class='st'>"frequency"</span>,
  <span class='kw'>percentile</span> <span class='kw'>=</span> <span class='fl'>90</span>, <span class='kw'>map</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>lon.inc</span> <span class='kw'>=</span> <span class='fl'>1</span>, <span class='kw'>lat.inc</span> <span class='kw'>=</span> <span class='fl'>1</span>, <span class='kw'>min.bin</span> <span class='kw'>=</span> <span class='fl'>1</span>,
  <span class='kw'>map.fill</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>map.res</span> <span class='kw'>=</span> <span class='st'>"default"</span>, <span class='kw'>map.cols</span> <span class='kw'>=</span> <span class='st'>"grey40"</span>,
  <span class='kw'>map.alpha</span> <span class='kw'>=</span> <span class='fl'>0.3</span>, <span class='kw'>projection</span> <span class='kw'>=</span> <span class='st'>"lambert"</span>, <span class='kw'>parameters</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>51</span>, <span class='fl'>51</span>),
  <span class='kw'>orientation</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>90</span>, <span class='fl'>0</span>, <span class='fl'>0</span>), <span class='kw'>grid.col</span> <span class='kw'>=</span> <span class='st'>"deepskyblue"</span>, <span class='kw'>origin</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='no'>...</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <dl class="dl-horizontal">
      <dt>mydata</dt>
      <dd>Data frame, the result of importing a trajectory
file using <code>importTraj</code></dd>
      <dt>lon</dt>
      <dd>Column containing the longitude, as a decimal.</dd>
      <dt>lat</dt>
      <dd>Column containing the latitude, as a decimal.</dd>
      <dt>pollutant</dt>
      <dd>Pollutant to be plotted. By default the
trajectory height is used.</dd>
      <dt>type</dt>
      <dd><code>type</code> determines how the data are split
i.e. conditioned, and then plotted. The default is will produce a
single plot using the entire data. Type can be one of the built-in
types as detailed in <code>cutData</code> e.g. &quot;season&quot;, &quot;year&quot;,
&quot;weekday&quot; and so on. For example, <code>type = &quot;season&quot;</code> will
produce four plots --- one for each season.

It is also possible to choose <code>type</code> as another variable in
the data frame. If that variable is numeric, then the data will be
split into four quantiles (if possible) and labelled
accordingly. If type is an existing character or factor variable,
then those categories/levels will be used directly. This offers
great flexibility for understanding the variation of different
variables and how they depend on one another.

<code>type</code> can be up length two e.g. <code>type = c(&quot;season&quot;,
&quot;weekday&quot;)</code> will produce a 2x2 plot split by season and day of the
week. Note, when two types are provided the first forms the
columns and the second the rows.</dd>
      <dt>smooth</dt>
      <dd>Should the trajectory surface be smoothed?</dd>
      <dt>statistic</dt>
      <dd>For <code>trajLevel</code>. By default the function
will plot the trajectory frequencies.

For <code>trajLevel</code>, the argument <code>method = &quot;hexbin&quot;</code> can be
used. In this case hexagonal binning of the trajectory
<em>points</em> (i.e. a point every three hours along each back
trajectory). The plot then shows the trajectory frequencies uses
hexagonal binning. This is an alternative way of viewing
trajectory frequencies compared with <code>statistic =
&quot;frequency&quot;</code>.

There are also various ways of plotting concentrations.

It is also possible to set <code>statistic = &quot;difference&quot;</code>. In
this case trajectories where the associated concentration is
greater than <code>percentile</code> are compared with the the full set
of trajectories to understand the differences in freqeuncies of
the origin of air masses. The comparsion is made by comparing the
percentage change in gridded frequencies. For example, such a plot
could show that the top 10% of concentrations of PM10 tend to
orginate from air-mass origins to the east.

If <code>statistic = &quot;pscf&quot;</code> then a Potential Source Contribution
Function map is produced. If <code>statistic = &quot;cwt&quot;</code> then
concentration weighted trajectories are plotted.

If <code>statistic = &quot;cwt&quot;</code> then the Concentration Weighted
Trajectory approach is used. See details.</dd>
      <dt>percentile</dt>
      <dd>For <code>trajLevel</code>. The percentile
concentration of <code>pollutant</code> against which the all
trajectories are compared.</dd>
      <dt>map</dt>
      <dd>Should a base map be drawn? If <code>TRUE</code> the world
base map from the <code>maps</code> package is used.</dd>
      <dt>lon.inc</dt>
      <dd>The longitude-interval to be used for binning data
for <code>trajLevel</code>.</dd>
      <dt>lat.inc</dt>
      <dd>The latitude-interval to be used for binning data
when <code>trajLevel</code>.</dd>
      <dt>min.bin</dt>
      <dd>For <code>trajLevel</code> the minimum number of unique
points in a grid cell. Counts below <code>min.bin</code> are set as
missing. For <code>trajLevel</code> gridded outputs.</dd>
      <dt>map.fill</dt>
      <dd>Should the base map be a filled polygon? Default
is to fill countries.</dd>
      <dt>map.res</dt>
      <dd>The resolution of the base map. By default the
function uses the &#8216;world&#8217; map from the <code>maps</code>
package. If <code>map.res = &quot;hires&quot;</code> then the (much) more detailed
base map &#8216;worldHires&#8217; from the <code>mapdata</code> package is
used. Use <code>library(mapdata)</code>. Also available is a map showing
the US states. In this case <code>map.res = &quot;state&quot;</code> should be
used.</dd>
      <dt>map.cols</dt>
      <dd>If <code>map.fill = TRUE</code> <code>map.cols</code> controls
the fill colour. Examples include <code>map.fill = &quot;grey40&quot;</code> and
<code>map.fill = openColours(&quot;default&quot;, 10)</code>. The latter colours
the countries and can help differentiate them.</dd>
      <dt>map.alpha</dt>
      <dd>The transpency level of the filled map which
takes values from 0 (full transparency) to 1 (full
opacity). Setting it below 1 can help view trajectories,
trajectory surfaces etc. <em>and</em> a filled base map.</dd>
      <dt>projection</dt>
      <dd>The map projection to be used. Different map
projections are possible through the <code>mapproj</code>
package. See <code>?mapproject</code> for extensive details and information
on setting other parameters and orientation (see below).</dd>
      <dt>parameters</dt>
      <dd>From the <code>mapproj</code> package. Optional
numeric vector of parameters for use with the projection
argument. This argument is optional only in the sense that certain
projections do not require additional parameters. If a projection
does not require additional parameters then set to null
i.e. <code>parameters = NULL</code>.</dd>
      <dt>orientation</dt>
      <dd>From the <code>mapproj</code> package. An optional
vector c(latitude, longitude, rotation) which describes where the
&quot;North Pole&quot; should be when computing the projection. Normally
this is c(90, 0), which is appropriate for cylindrical and conic
projections. For a planar projection, you should set it to the
desired point of tangency. The third value is a clockwise rotation
(in degrees), which defaults to the midrange of the longitude
coordinates in the map.</dd>
      <dt>grid.col</dt>
      <dd>The colour of the map grid to be used. To remove
the grid set <code>grid.col = &quot;transparent&quot;</code>.</dd>
      <dt>origin</dt>
      <dd>should the receptor origin be shown by a black dot?</dd>
      <dt>...</dt>
      <dd>other arguments are passed to <code>cutData</code> and
<code>scatterPlot</code>. This provides access to arguments used in both
these functions and functions that they in turn pass arguments on
to. For example, <code>plotTraj</code> passes the argument <code>cex</code> on
to <code>scatterPlot</code> which in turn passes it on to the
<code>lattice</code> function <code>xyplot</code> where it is applied to set
the plot symbol size.</dd>
    </dl>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>An alternative way of showing the trajectories compared with
plotting trajectory lines is to bin the points into
latitude/longitude intervals. For these purposes <code>trajLevel</code>
should be used. There are several trajectory statistics that can
be plotted as gridded surfaces. First, <code>statistic</code> can be set
to &#8220;frequency&#8221; to show the number of back trajectory points
in a grid square. Grid squares are by default at 1 degree
intervals, controlled by <code>lat.inc</code> and <code>lon.inc</code>. Such
plots are useful for showing the frequency of air mass
locations. Note that it is also possible to set <code>method =
&quot;hexbin&quot;</code> for plotting frequencies (not concentrations), which
will produce a plot by hexagonal binning.</p>
    <p>If <code>statistic = &quot;difference&quot;</code> the trajectories associated
with a concentration greater than <code>percentile</code> are compared
with the the full set of trajectories to understand the
differences in freqeuncies of the origin of air masses of the
highest concentration trajectories compared with the trajectories
on average. The comparsion is made by comparing the percentage
change in gridded frequencies. For example, such a plot could show
that the top 10% of concentrations of PM10 tend to orginate from
air-mass origins to the east.</p>
    <p>If <code>statistic = &quot;pscf&quot;</code> then the Potential Source
Contribution Function is plotted. The PSCF calculates the
probability that a source is located at latitude \(i\) and
longitude \(j\) (Pekney et al., 2006).The basis of PSCF is that
if a source is located at (i,j), an air parcel back trajectory
passing through that location indicates that material from the
source can be collected and transported along the trajectory to
the receptor site. PSCF solves $$PSCF = m_{ij}/n_{ij}$$ where
\(n_{ij}\) is the number of times that the trajectories passed
through the cell (i,j) and \(m_{ij}\) is the number of times
that a source concentration was high when the trajectories passed
through the cell (i,j). The criterion for de-termining
\(m_{ij}\) is controlled by <code>percentile</code>, which by default
is 90. Note also that cells with few data have a weighting factor
applied to reduce their effect.</p>
    <p>A limitation of the PSCF method is that grid cells can have the
same PSCF value when sample concentrations are either only
slightly higher or much higher than the criterion. As a result, it
can be difficult to distinguish moderate sources from strong
ones. Seibert et al. (1994) computed concentration fields to
identify source areas of pollutants. The Concentration Weighted
Trajectory (CWT) approach considers the concentration of a species
together with its residence time in a grid cell. The CWT approach
has been shown to yield similar results to the PSCF approach. The
openair manual has more details and examples of these approaches.</p>
    <p>A further useful refinement is to smooth the resulting surface,
which is possible by setting <code>smooth = TRUE</code>.</p>
    
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>This function is under active development and is likely to change</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Pekney, N. J., Davidson, C. I., Zhou, L., &amp; Hopke,
P. K. (2006). Application of PSCF and CPF to PMF-Modeled Sources
of PM 2.5 in Pittsburgh. Aerosol Science and Technology, 40(10),
952-961.</p>
    <p>Seibert, P., Kromp-Kolb, H., Baltensperger, U., Jost, D.,
1994. Trajectory analysis of high-alpine air pollution data. NATO
Challenges of Modern Society 18, 595-595.</p>
    <p>Xie, Y., &amp; Berkowitz, C. M. (2007). The use of conditional
probability functions and potential source contribution functions
to identify source regions and advection pathways of hydrocarbon
emissions in Houston, Texas. Atmospheric Environment, 41(28),
5831-5847.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p><code><a href='importTraj.html'>importTraj</a></code> to import trajectory data from the King&#39;s
College server and <code><a href='trajPlot.html'>trajPlot</a></code> for plotting back trajectory lines.</p>
    

    <h2 class="hasAnchor" id="examples">
      <a class="anchor" href="#examples"></a>
      Examples
    </h2>
    <pre class="examples"><div class='input'>
<span class='co'># show a simple case with no pollutant i.e. just the trajectories</span>
<span class='co'># let's check to see where the trajectories were coming from when</span>
<span class='co'># Heathrow Airport was closed due to the Icelandic volcanic eruption</span>
<span class='co'># 15--21 April 2010.</span>
<span class='co'># import trajectories for London and plot</span>
<span class='co'>## Not run: ------------------------------------</span>
<span class='co'># lond &lt;- importTraj("london", 2010)</span>
<span class='co'>## ---------------------------------------------</span>
<span class='co'># more examples to follow linking with concentration measurements...</span>

<span class='co'># import some measurements from KC1 - London</span>
<span class='co'>## Not run: ------------------------------------</span>
<span class='co'># kc1 &lt;- importAURN("kc1", year = 2010)</span>
<span class='co'># # now merge with trajectory data by 'date'</span>
<span class='co'># lond &lt;- merge(lond, kc1, by = "date")</span>
<span class='co'># </span>
<span class='co'># # trajectory plot, no smoothing - and limit lat/lon area of interest</span>
<span class='co'># # use PSCF</span>
<span class='co'># trajLevel(subset(lond, lat &gt; 40 &amp; lat &lt; 70 &amp; lon &gt;-20 &amp; lon &lt;20),</span>
<span class='co'># pollutant = "pm10", statistic = "pscf")</span>
<span class='co'># </span>
<span class='co'># # can smooth surface, suing CWT approach:</span>
<span class='co'># trajLevel(subset(lond, lat &gt; 40 &amp; lat &lt; 70 &amp; lon &gt;-20 &amp; lon &lt;20),</span>
<span class='co'># pollutant = "pm2.5", statistic = "cwt",  smooth = TRUE)</span>
<span class='co'># </span>
<span class='co'># # plot by season:</span>
<span class='co'># trajLevel(subset(lond, lat &gt; 40 &amp; lat &lt; 70 &amp; lon &gt;-20 &amp; lon &lt;20), pollutant = "pm2.5",</span>
<span class='co'># statistic = "pscf", type = "season")</span>
<span class='co'>## ---------------------------------------------</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#details">Details</a></li>

      <li><a href="#note">Note</a></li>

      <li><a href="#references">References</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

    <h2>Author</h2>
    
David Carslaw

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by David Carslaw, Karl Ropkins.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
